<html>
<head>
<!-- Load the d3 library. -->
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<!-- for the map! -->
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script src="tip.js"></script>
<link href='http://fonts.googleapis.com/css?family=Lato&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
<style>
svg { /*border: solid black 1px;*/ display:block; margin-bottom:20;}
body {margin: 40px;}
.d3-tip {
  line-height: 1;
  padding: 12px;
  background: rgba(0, 0, 0, 0.8);
  color: #fff;
  border-radius: 2px;
  text-align: center;
  font-size: .9em;
  font-family: "Lato", sans-serif;
}

/* Creates a small triangle extender for the tooltip */
.d3-tip:after {
  box-sizing: border-box;
  display: inline;
  font-size: 7px;
  width: 100%;
  line-height: 1;
  color: rgba(0, 0, 0, 0.8);
  content: "\25BC";
  position: absolute;
  text-align: center;
}

.d3-tip.n:after {
  margin: -1px 0 0 0;
  top: 100%;
  left: 0;
}

</style>
</head>
<body>

<div id="storiesMap" style="padding-top:200px;margin:0 auto;"></div>

<script> 
var STORY_MAP_HEIGHT = 550,
	STORY_MAP_WIDTH = 900;

var MAX_CIRCLE_SIZE = 50,
	MIN_CIRCLE_SIZE = 5;

var monthDict = {1:'Jan', 2:'Feb', 3:'Mar', 4:'Apr', 5:'May', 6:'Jun', 7:'Jul', 8:'Aug', 9:'Sep', 10:'Oct', 11:'Nov', 12:'Dec'};

var mapSVG = d3.select("#storiesMap").append("svg")
	.attr("height",STORY_MAP_HEIGHT)
	.attr("width", STORY_MAP_WIDTH)
	.style("margin", "0 auto");

var g = mapSVG.append("g");
//place projection within bounds of the svg element
var projection = d3.geo.albersUsa();
var path = d3.geo.path().projection(projection);

var tip = d3.tip()
  .attr('class', 'd3-tip')
  .offset([-10, 0])
  .html(function(d) {
  	var listOfWords = d.Story.split(" ");
  	var accString = "<br/><br/>";
  	var lineCount = 0;
  	//put in some line breaks at nice lengths
  	for(i=0; i<listOfWords.length; i++){
  		if (lineCount + listOfWords[i].length >45 && i!=(listOfWords.length - 1)){
  			accString+="<br/>";
  			lineCount = 0;
  		}
  		accString+=listOfWords[i] + " ";
  		lineCount += listOfWords[i].length;
  		
  	}
    return "<b><span style='color:#D05050;font-size:1.3em;padding:7px;'>" + d.Location + "</span></b><br/>"+ monthDict[d.Month] +" "+d.Year+"<br/><br/><b>Number of Cases:</b> " + String(d["Number Affected"]) + 
    	accString + "<br/><br/><b>Country of Origin: </b>" + d.Origin;
  })

mapSVG.call(tip);


var stories;
d3.json("stories.json", function(error, data) {
	stories = data;

	var minOutbreaks = d3.min(stories, function(d){return d['Number Affected'];});
	var maxOutbreaks = d3.max(stories, function(d){return d['Number Affected'];});

	var radiusScale = d3.scale.sqrt().domain([minOutbreaks, maxOutbreaks]).range([MIN_CIRCLE_SIZE, MAX_CIRCLE_SIZE]);

	d3.json("us-10m.json", function(error, mapData) {
		//create and color map
		g.selectAll("path").data(topojson.feature(mapData,mapData.objects.states).features)
		.enter().append("path")
		.attr("d", path)
		.style("stroke", "white")
		.style("fill","lightgray")
		.style("stroke-width", 1);
		
		var coords; 
		
		//pins
		var circles = mapSVG.selectAll("circle").data(stories).enter().append("circle")
			.attr("cx", function(outbreak){coords = projection([outbreak.Longitude, outbreak.Latitude]); return coords[0];})
			.attr("cy", function(outbreak){coords = projection([outbreak.Longitude, outbreak.Latitude]); return coords[1];})
			.attr("r", function(outbreak){return radiusScale(outbreak['Number Affected']);})
			.style("fill", "maroon")
			.style("opacity", 0.5)
			.on('mouseover', tip.show)
      		.on('mouseout', tip.hide);
	});
});

</script>